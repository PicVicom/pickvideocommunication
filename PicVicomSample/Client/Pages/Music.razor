@page "/music"
@inject IJSRuntime JS
@inject HttpClient Http
@inject AuthenticationStateProvider AuthenticationStateProvider

<hr />

<div id="stream"></div>
<div>
    <RadzenUpload Url=@uploadUrl Progress="@((args) => OnProgress(args))" Accept="audio/mp3" />
    <h4>@progress%</h4>
</div>
<hr />

<Chat RoomID="@roomID" UserId="@UserId"></Chat>

<QueInfo RoomId="roomID"></QueInfo>

@code
{

    public int roomID = 2;

    public string uploadUrl = string.Empty;

    public int StreamingType = (int)StreamingTypeEnum.Music;

    private IEnumerable<Claim> _claims = Enumerable.Empty<Claim>();
    private string UserId;

    private async Task GetClaimsPrincipalData()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            UserId = user.Identity.Name;
            _claims = user.Claims;
        }
        else
        {
            Random r = new Random();
            var userUid = r.Next(1000, 100000);
            UserId = $"ㅇㅇ({userUid})";
        }
    }

    protected override void OnInitialized()
    {
        GetClaimsPrincipalData();
        JS.InvokeVoidAsync("SetJanusValues", roomID, UserId, StreamingType);
        JS.InvokeVoidAsync("JanusInit", null);
        uploadUrl = @$"upload/music/{roomID}/{UserId}";
    }

    int progress;

    void OnProgress(Radzen.UploadProgressArgs args)
    {
        this.progress = args.Progress;
    }

    private class StreamingInfo
    {
        public int RoomID { get; set; }
        public string Owner { get; set; }
        public string FileName { get; set; }
    }
}